import pandas as pd
import pandas_profiling as pdp
import multiprocessing
from tqdm import tqdm
import setting
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import MinMaxScaler, LabelEncoder
from sklearn.model_selection import train_test_split
from sklearn.metrics import classification_report, roc_curve, auc, accuracy_score


dtypes = setting.DTYPES


def load_dataframe(dataset):
    usecols = dtypes.keys()
    if dataset == 'test':
        usecols = [col for col in dtypes.keys() if col != 'HasDetections']
    df = pd.read_csv(f'data/{dataset}.csv', dtype=dtypes, usecols=usecols)
    return df


if __name__ == '__main__':
    # with multiprocessing.Pool() as pool:
    #     df_train = pool.map(load_dataframe, ["train"])
    df_train = load_dataframe('train')

    # print(df_train.info())

    x_train = df_train.drop(['MachineIdentifier', 'HasDetections'], axis=1)
    y_train = df_train['HasDetections']

    y_train = pd.get_dummies(y_train)

    x_train.fillna(x_train.median(), inplace=True)
    x_train.replace('<', '', inplace=True)
    le = LabelEncoder()

    x_dtypes = x_train.dtypes
    for column in x_dtypes[x_dtypes == 'object'].index:
        le = LabelEncoder()
        le.fit(x_train[column])
        x_train[column] = le.transform(x_train[column].astype('str'))

    x_train, y_train, x_valid, y_valid = train_test_split(x_train, y_train, test_size=0.2, random_state=0)

    print('x train shape:', x_train.shape)
    print('x valid shape:', x_valid.shape)
    print('y train shape:', y_train.shape)
    print('y valid shape:', y_valid.shape)

    clf = RandomForestClassifier(n_jobs=-1, verbose=3)
    clf.fit(x_train, y_train)
    y_pred = clf.predict(x_valid)
    y_pred = pd.get_dummies(pd.Series(y_pred))

    fpr, tpr, thresholds = roc_curve(y_valid, y_pred, pos_label=1)
    auc(fpr, tpr)

    print(accuracy_score(y_valid, y_pred))
    print(classification_report(y_valid, y_pred))
