import pandas as pd
import pandas_profiling as pdp
import multiprocessing
from tqdm import tqdm
import setting
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import MinMaxScaler, LabelEncoder
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.metrics import classification_report, roc_curve, auc, accuracy_score
import xgboost as xgb
import matplotlib.pyplot as plt

dtypes = setting.DTYPES


def load_dataframe(dataset):
    usecols = dtypes.keys()
    if dataset == 'test':
        usecols = [col for col in dtypes.keys() if col != 'HasDetections']
    df = pd.read_csv(f'data/{dataset}.csv', dtype=dtypes, usecols=usecols, header=0, index_col=0)
    return df


if __name__ == '__main__':
    with multiprocessing.Pool() as pool:
        df_train, df_test = pool.map(load_dataframe, ["train", "test"])
    # df_train = load_dataframe('train')

    # print(df_train.info())

    x_train = df_train.drop(['HasDetections'], axis=1)
    y_train = df_train['HasDetections']

    # y_train = pd.get_dummies(y_train)

    x_train.fillna(x_train.median(), inplace=True)
    # x_train.replace('<', '', inplace=True)
    le = LabelEncoder()

    x_dtypes = x_train.dtypes
    for column in x_dtypes[x_dtypes == 'object'].index:
        le = LabelEncoder()
        x_train[column] = le.fit_transform(x_train[column].astype(str))

    x_train = MinMaxScaler().fit_transform(x_train)

    x_train, x_valid, y_train, y_valid = train_test_split(x_train, y_train, test_size=0.2, random_state=0)

    print('x train shape:', x_train.shape)
    print('x valid shape:', x_valid.shape)
    print('y train shape:', y_train.shape)
    print('y valid shape:', y_valid.shape)

    clf = xgb.XGBClassifier(n_jobs=-1, n_estimators=100)
    # clf = RandomForestClassifier(n_jobs=-1, verbose=3)
    clf.fit(x_train, y_train)
    y_pred = clf.predict(x_valid)
    y_pred = pd.Series(y_pred)

    fpr, tpr, thresholds = roc_curve(y_valid, y_pred, pos_label=1)

    print(accuracy_score(y_valid, y_pred))
    print(classification_report(y_valid, y_pred))
    print(auc(fpr, tpr))

    plt.plot(fpr, tpr, label='ROC curve (area = %.2f)'%auc)
    plt.legend()
    plt.title('ROC curve')
    plt.xlabel('False Positive Rate')
    plt.ylabel('True Positive Rate')
    plt.grid(True)
    plt.show()
    plt.savefig('roc curve')

    y_pred_proba = clf.predict_proba(x_valid)
    df_proba = pd.DataFrame(y_pred_proba)
    print(y_pred_proba)
